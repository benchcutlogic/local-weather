---
import Layout from "../layouts/Layout.astro";
import { getCityBySlug, metersToFeet, CITIES } from "../lib/cities";
import { fetchCommentary, fetchReports } from "../lib/api";
import type { Commentary, CrowdReportRow } from "../lib/api";

const { city: citySlug } = Astro.params;

const cityConfig = getCityBySlug(citySlug!);
if (!cityConfig) {
  return Astro.redirect("/");
}

const commentary: Commentary | null = await fetchCommentary(citySlug!);

// Fetch crowdsourced reports from D1
let reports: CrowdReportRow[] = [];
try {
  const runtime = Astro.locals.runtime;
  if (runtime?.env?.DB) {
    reports = await fetchReports(citySlug!, runtime.env.DB);
  }
} catch {
  // D1 not available in dev or reports table not created yet
}

const confidenceColors: Record<string, string> = {
  high: "bg-green-100 text-green-800 border-green-200",
  moderate: "bg-yellow-100 text-yellow-800 border-yellow-200",
  low: "bg-red-100 text-red-800 border-red-200",
};

function kelvinToF(k: number | null | undefined): string {
  if (k == null) return "—";
  return `${Math.round((k - 273.15) * 9 / 5 + 32)}°F`;
}

function timeAgo(iso: string): string {
  const diff = Date.now() - new Date(iso).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 60) return `${mins}m ago`;
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return `${hrs}h ago`;
  return `${Math.floor(hrs / 24)}d ago`;
}
---

<Layout
  title={`${cityConfig.name}, ${cityConfig.state} Weather`}
  description={commentary?.headline || `Hyperlocal weather forecast for ${cityConfig.name}, ${cityConfig.state}`}
>
  <!-- Breadcrumb -->
  <nav class="text-sm text-wx-500 mb-4">
    <a href="/" class="hover:text-wx-700">Cities</a>
    <span class="mx-1">/</span>
    <span class="text-wx-900 font-medium">{cityConfig.name}, {cityConfig.state}</span>
  </nav>

  {commentary ? (
    <div>
      <!-- Headline -->
      <div class="bg-gradient-to-r from-wx-800 to-wx-900 text-white rounded-xl p-6 mb-6">
        <h1 class="text-2xl md:text-3xl font-bold mb-2">{commentary.headline}</h1>
        <div class="flex flex-wrap items-center gap-3 text-sm text-wx-200">
          <span>Updated {timeAgo(commentary.updated_at)}</span>
          {commentary.confidence && (
            <span
              class={`px-2 py-0.5 rounded-full text-xs font-medium border
                ${confidenceColors[commentary.confidence.level] || "bg-gray-100 text-gray-800"}`}
            >
              {commentary.confidence.level.toUpperCase()} confidence
            </span>
          )}
          {commentary.best_model && (
            <span class="text-wx-300">
              Best model: <span class="text-white font-medium">{commentary.best_model}</span>
            </span>
          )}
        </div>
      </div>

      <!-- Alerts -->
      {commentary.alerts && commentary.alerts.length > 0 && (
        <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
          {commentary.alerts.map((alert) => (
            <p class="text-red-800 font-medium text-sm">{alert}</p>
          ))}
        </div>
      )}

      <!-- Main Content Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Main Forecast -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Current Conditions -->
          <section class="bg-white rounded-xl shadow-sm border border-wx-100 p-6">
            <h2 class="text-lg font-bold text-wx-900 mb-3">Current Conditions</h2>
            <p class="text-wx-700 leading-relaxed">{commentary.current_conditions}</p>
          </section>

          <!-- Today's Forecast -->
          <section class="bg-white rounded-xl shadow-sm border border-wx-100 p-6">
            <h2 class="text-lg font-bold text-wx-900 mb-3">Today's Forecast</h2>
            <p class="text-wx-700 leading-relaxed">{commentary.todays_forecast}</p>
          </section>

          <!-- Model Analysis -->
          <section class="bg-white rounded-xl shadow-sm border border-wx-100 p-6">
            <h2 class="text-lg font-bold text-wx-900 mb-3">Model Analysis</h2>
            <p class="text-wx-700 leading-relaxed">{commentary.model_analysis}</p>
            <div class="mt-3 text-sm text-wx-500">
              <p>{commentary.confidence.explanation}</p>
            </div>
          </section>

          <!-- Elevation Breakdown -->
          <section class="bg-white rounded-xl shadow-sm border border-wx-100 p-6">
            <h2 class="text-lg font-bold text-wx-900 mb-3">Elevation Breakdown</h2>
            <p class="text-wx-700 leading-relaxed mb-4">{commentary.elevation_breakdown.summary}</p>
            <div class="space-y-3">
              {commentary.elevation_breakdown.bands.map((band) => (
                <div class="flex items-start gap-3 pl-3 border-l-2 border-wx-200">
                  <span class="font-mono text-sm font-semibold text-wx-600 whitespace-nowrap min-w-[80px]">
                    {band.elevation_ft.toLocaleString()} ft
                  </span>
                  <p class="text-sm text-wx-700">{band.description}</p>
                </div>
              ))}
            </div>
          </section>

          <!-- Extended Outlook -->
          <section class="bg-white rounded-xl shadow-sm border border-wx-100 p-6">
            <h2 class="text-lg font-bold text-wx-900 mb-3">7-Day Outlook</h2>
            <p class="text-wx-700 leading-relaxed">{commentary.extended_outlook}</p>
          </section>
        </div>

        <!-- Right Column: Sidebar -->
        <div class="space-y-6">
          <!-- Verification Scores -->
          <section class="bg-white rounded-xl shadow-sm border border-wx-100 p-6">
            <h2 class="text-lg font-bold text-wx-900 mb-3">Model Accuracy</h2>
            <p class="text-xs text-wx-500 mb-3">30-day rolling verification (RMSE, lower = better)</p>
            <div class="space-y-2">
              {["HRRR", "GFS", "NAM", "ECMWF"].map((model) => (
                <div class="flex items-center justify-between py-1.5 border-b border-wx-50 last:border-0">
                  <span class="text-sm font-medium text-wx-800">{model}</span>
                  <span
                    class={`text-xs px-2 py-0.5 rounded-full ${
                      commentary.best_model === model
                        ? "bg-green-100 text-green-700 font-semibold"
                        : "bg-wx-50 text-wx-600"
                    }`}
                  >
                    {commentary.best_model === model ? "Most Accurate" : "—"}
                  </span>
                </div>
              ))}
            </div>
          </section>

          <!-- Model Drift (Premium Teaser) -->
          <section class="bg-white rounded-xl shadow-sm border border-wx-100 p-6">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-lg font-bold text-wx-900">Model Drift</h2>
              <span class="text-xs bg-wx-100 text-wx-600 px-2 py-0.5 rounded-full font-medium">
                Last 5 runs
              </span>
            </div>
            <div class="h-32 bg-wx-50 rounded-lg flex items-center justify-center mb-3">
              <p class="text-sm text-wx-400">Drift chart placeholder</p>
            </div>
            <a
              href="#subscribe"
              class="block text-center text-sm text-wx-600 hover:text-wx-800 font-medium"
            >
              Unlock detailed model comparison charts
            </a>
          </section>

          <!-- Crowdsourced Reports -->
          <section class="bg-white rounded-xl shadow-sm border border-wx-100 p-6">
            <h2 class="text-lg font-bold text-wx-900 mb-3">Community Reports</h2>
            {reports.length > 0 ? (
              <div class="space-y-2 mb-4 max-h-48 overflow-y-auto">
                {reports.map((report) => (
                  <div class="text-sm border-b border-wx-50 pb-2 last:border-0">
                    <div class="flex justify-between text-wx-500 text-xs">
                      <span>{timeAgo(report.created_at)}</span>
                      {report.temp != null && <span>{kelvinToF(report.temp)}</span>}
                    </div>
                    {report.notes && <p class="text-wx-700 mt-0.5">{report.notes}</p>}
                  </div>
                ))}
              </div>
            ) : (
              <p class="text-sm text-wx-400 mb-4">No reports yet. Be the first!</p>
            )}

            <!-- Report Form -->
            <form id="report-form" class="space-y-2">
              <input type="hidden" name="city_slug" value={citySlug} />
              <textarea
                name="notes"
                placeholder="What's it like outside?"
                rows="2"
                class="w-full px-3 py-2 text-sm border border-wx-200 rounded-lg
                       focus:outline-none focus:ring-2 focus:ring-wx-500 resize-none"
              />
              <div class="grid grid-cols-2 gap-2">
                <input
                  type="number"
                  name="temp_f"
                  placeholder="Temp (°F)"
                  step="1"
                  class="px-3 py-1.5 text-sm border border-wx-200 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-wx-500"
                />
                <input
                  type="number"
                  name="snow_in"
                  placeholder="Snow (in)"
                  step="0.1"
                  class="px-3 py-1.5 text-sm border border-wx-200 rounded-lg
                         focus:outline-none focus:ring-2 focus:ring-wx-500"
                />
              </div>
              <button
                type="submit"
                class="w-full bg-wx-600 hover:bg-wx-500 text-white text-sm font-medium
                       py-2 rounded-lg transition-colors"
              >
                Submit Report
              </button>
            </form>
          </section>

          <!-- Subscribe -->
          <section id="subscribe" class="bg-gradient-to-br from-wx-800 to-wx-950 text-white rounded-xl p-6">
            <h2 class="text-lg font-bold mb-2">Premium Access</h2>
            <ul class="text-sm text-wx-200 space-y-1.5 mb-4">
              <li>Detailed model comparison charts</li>
              <li>Extended elevation band analysis</li>
              <li>Push alerts for significant model drift</li>
              <li>API access for integrations</li>
            </ul>
            <a
              href="https://buy.stripe.com/your_link_here"
              class="block text-center bg-white text-wx-900 px-4 py-2.5 rounded-lg
                     font-semibold hover:bg-wx-50 transition-colors"
            >
              Subscribe — $5/mo
            </a>
          </section>
        </div>
      </div>
    </div>
  ) : (
    <!-- No Commentary Available -->
    <div class="text-center py-16">
      <h1 class="text-3xl font-bold text-wx-900 mb-3">
        {cityConfig.name}, {cityConfig.state}
      </h1>
      <p class="text-wx-600 mb-2">
        Forecast commentary is being generated. Check back soon!
      </p>
      <p class="text-sm text-wx-400">
        Tracking {cityConfig.elevBands.length} elevation bands from{" "}
        {metersToFeet(cityConfig.elevBands[0]).toLocaleString()} ft to{" "}
        {metersToFeet(cityConfig.elevBands[cityConfig.elevBands.length - 1]).toLocaleString()} ft.
      </p>
    </div>
  )}

  <script>
    const form = document.getElementById("report-form") as HTMLFormElement;
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(form);

      const tempF = fd.get("temp_f");
      const snowIn = fd.get("snow_in");

      const body: Record<string, unknown> = {
        city_slug: fd.get("city_slug"),
        notes: fd.get("notes") || undefined,
      };

      if (tempF && String(tempF).trim()) {
        body.temp = ((parseFloat(String(tempF)) - 32) * 5) / 9 + 273.15;
      }
      if (snowIn && String(snowIn).trim()) {
        body.snow = parseFloat(String(snowIn)) * 0.0254;
      }

      try {
        const res = await fetch("/api/report", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        if (res.ok) {
          form.reset();
          window.location.reload();
        }
      } catch {
        // Silently fail
      }
    });
  </script>
</Layout>
