name: Build & Deploy

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "services/**"
      - "frontend/**"
      - ".github/workflows/deploy.yml"

permissions:
  contents: read
  id-token: write

env:
  GCP_REGION: us-central1
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/weather-services
  WORKLOAD_IDENTITY_PROVIDER: ${{ vars.WORKLOAD_IDENTITY_PROVIDER }}
  SERVICE_ACCOUNT: ${{ vars.DEPLOY_SERVICE_ACCOUNT }}

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      ingest: ${{ steps.filter.outputs.ingest }}
      commentary: ${{ steps.filter.outputs.commentary }}
      gee: ${{ steps.filter.outputs.gee }}
      frontend: ${{ steps.filter.outputs.frontend }}
      gcp_ready: ${{ steps.check.outputs.gcp_ready }}
      cf_ready: ${{ steps.check.outputs.cf_ready }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ingest:
              - 'services/ingest/**'
            commentary:
              - 'services/commentary/**'
            gee:
              - 'services/gee/**'
            frontend:
              - 'frontend/**'
      - id: check
        run: |
          if [[ -n "${{ secrets.GCP_PROJECT_ID }}" && -n "${{ vars.WORKLOAD_IDENTITY_PROVIDER }}" && -n "${{ vars.DEPLOY_SERVICE_ACCOUNT }}" ]]; then
            echo "gcp_ready=true" >> $GITHUB_OUTPUT
          else
            echo "gcp_ready=false" >> $GITHUB_OUTPUT
          fi
          [[ -n "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]] && echo "cf_ready=true" >> $GITHUB_OUTPUT || echo "cf_ready=false" >> $GITHUB_OUTPUT

  deploy-ingest:
    name: Deploy Ingest Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.ingest == 'true' && needs.detect-changes.outputs.gcp_ready == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        run: |
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev/$(echo "${{ env.GCP_PROJECT_ID }}" | tr -d '[:space:]')/weather-services"
          docker build -t ${REGISTRY}/grib2-parser:${{ github.sha }} \
                        -t ${REGISTRY}/grib2-parser:latest \
                        services/ingest/
          docker push ${REGISTRY}/grib2-parser:${{ github.sha }}
          docker push ${REGISTRY}/grib2-parser:latest

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: grib2-byte-parser
          region: ${{ env.GCP_REGION }}
          image: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/weather-services/grib2-parser:${{ github.sha }}

  deploy-commentary:
    name: Deploy Commentary Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.commentary == 'true' && needs.detect-changes.outputs.gcp_ready == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and Push
        run: |
          REGISTRY="${{ env.GCP_REGION }}-docker.pkg.dev/$(echo "${{ env.GCP_PROJECT_ID }}" | tr -d '[:space:]')/weather-services"
          docker build -t ${REGISTRY}/llm-commentary:${{ github.sha }} \
                        -t ${REGISTRY}/llm-commentary:latest \
                        services/commentary/
          docker push ${REGISTRY}/llm-commentary:${{ github.sha }}
          docker push ${REGISTRY}/llm-commentary:latest

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: gemini-forecast-commentary
          region: ${{ env.GCP_REGION }}
          image: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/weather-services/llm-commentary:${{ github.sha }}

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true' && needs.detect-changes.outputs.cf_ready == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install Dependencies
        working-directory: frontend
        run: npm install

      - name: Build
        working-directory: frontend
        run: npm run build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: frontend
          command: pages deploy dist --project-name=hyperlocal-wx-app
